<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Šachy — 2 Zařízení</title>
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<style>
body{margin:0;font-family:system-ui;background:#0f1720;color:#e6eef8;display:flex;flex-direction:column;align-items:center;padding:12px}
h1{margin:12px 0;font-size:1.5rem;text-align:center}
.panel{background:#0b1220;padding:12px;border-radius:12px;margin-bottom:12px;width:min(95vw,500px)}
button{padding:8px 12px;border:none;border-radius:8px;background:#7c3aed;color:white;font-weight:600;cursor:pointer}
button.ghost{background:transparent;border:1px solid #7c3aed;color:#7c3aed}
input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#081021;color:#e6eef8;margin-top:6px}
#board{display:grid;grid-template-columns:repeat(8,1fr);width:min(90vw,480px);aspect-ratio:1/1;border:4px solid #333;border-radius:8px;overflow:hidden;margin-top:12px}
.cell{display:flex;align-items:center;justify-content:center;font-size:clamp(20px,6vw,40px);cursor:pointer;user-select:none}
.light{background:#eeeed2;color:#111}
.dark{background:#769656;color:#111}
.cell.selected{outline:3px solid yellow}
.controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center}
.status{margin-top:8px;font-size:1rem;text-align:center}
textarea{resize:vertical}
</style>
</head>
<body>
<h1>Online Šachy — 2 ZAŘÍZENÍ</h1>

<div id="lobbyPanel" class="panel">
  <button id="oneDeviceBtn">1 ZAŘÍZENÍ</button>
  <button id="twoDeviceBtn">2 ZAŘÍZENÍ</button>
</div>

<div id="codePanel" class="panel" style="display:none">
  <div id="hostPanel" style="display:none">
    <h3>Host</h3>
    <button id="createHostBtn">Vytvořit hru</button>
    <textarea id="hostSignal" rows="4" readonly placeholder="Signál hosta se zde objeví po vytvoření"></textarea>
  </div>
  <div id="guestPanel" style="display:none">
    <h3>Guest</h3>
    <textarea id="guestInput" rows="4" placeholder="Vlož signál hosta"></textarea>
    <button id="guestApplyBtn">Připojit</button>
  </div>
</div>

<div id="gamePanel" class="panel" style="display:none">
  <div id="turnInfo" class="status">Tah: White</div>
  <div id="board"></div>
  <div class="controls">
    <button id="flipBtn">Otočit desku</button>
    <button id="restartBtn">Restart</button>
  </div>
</div>

<script>
// ====== Core ======
let chess = new Chess();
let orientation='white', selected=null;
let peer=null, connected=false;

// DOM refs
const lobbyPanel=document.getElementById('lobbyPanel');
const codePanel=document.getElementById('codePanel');
const hostPanel=document.getElementById('hostPanel');
const guestPanel=document.getElementById('guestPanel');
const gamePanel=document.getElementById('gamePanel');
const hostSignal=document.getElementById('hostSignal');
const guestInput=document.getElementById('guestInput');
const turnInfo=document.getElementById('turnInfo');
const boardDiv=document.getElementById('board');

// ====== Render ======
function pieceToUnicode(p){const m={p:{w:'♙',b:'♟'},r:{w:'♖',b:'♜'},n:{w:'♘',b:'♞'},b:{w:'♗',b:'♝'},q:{w:'♕',b:'♛'},k:{w:'♔',b:'♚'}};return m[p.type][p.color];}
function renderBoard(){
  boardDiv.innerHTML='';
  const b = chess.board();
  const disp = orientation==='white'?b:b.slice().reverse().map(r=>r.slice().reverse());
  disp.forEach((row,r)=>row.forEach((cell,c)=>{
    const div=document.createElement('div');
    div.className='cell '+((r+c)%2?'dark':'light');
    if(cell) div.textContent=pieceToUnicode(cell);
    div.onclick=()=>onCellClick(r,c);
    boardDiv.appendChild(div);
  }));
  turnInfo.textContent='Tah: '+(chess.turn()==='w'?'White':'Black');
  highlightSelected();
}
function coord(r,c){const f='abcdefgh',rk='87654321';return orientation==='white'?f[c]+rk[r]:f[7-c]+rk[7-r];}
function algebraicToRenderIndex(sq){const f='abcdefgh',r='87654321';const c=f.indexOf(sq[0]),row=r.indexOf(sq[1]);return orientation==='white'?{r:row,c:c}:{r:7-row,c:7-c};}
function highlightSelected(){if(!selected)return;const coords=algebraicToRenderIndex(selected);const idx=coords.r*8+coords.c;boardDiv.children[idx].classList.add('selected');}

// ====== Click ======
function onCellClick(r,c){
  const sq=coord(r,c);
  const p=chess.get(sq);
  if(selected){
    const move=chess.move({from:selected,to:sq,promotion:'q'});
    if(move) selected=null;
    else if(p&&p.color===chess.turn()) selected=sq;
    else selected=null;
  }else if(p&&p.color===chess.turn()) selected=sq;
  renderBoard();
  // broadcast move if networked
  if(peer&&connected) peer.send(JSON.stringify({type:'move',fen:chess.fen()}));
}

// ====== Buttons ======
document.getElementById('flipBtn').onclick=()=>{orientation=orientation==='white'?'black':'white';renderBoard();}
document.getElementById('restartBtn').onclick=()=>{chess.reset();selected=null;renderBoard();}

// ====== Lobby ======
document.getElementById('oneDeviceBtn').onclick=()=>{
  lobbyPanel.style.display='none';
  gamePanel.style.display='block';
  renderBoard();
}

document.getElementById('twoDeviceBtn').onclick=()=>{
  lobbyPanel.style.display='none';
  codePanel.style.display='block';
  hostPanel.style.display='block';
  guestPanel.style.display='block';
}

// ====== Networking ======
document.getElementById('createHostBtn').onclick=()=>{
  peer=new SimplePeer({initiator:true,trickle:false});
  hostSignal.value='';
  peer.on('signal',data=>hostSignal.value=JSON.stringify(data));
  peer.on('connect',()=>{connected=true;alert('Guest se připojil');});
  peer.on('data',d=>{
    const obj=JSON.parse(d.toString());
    if(obj.type==='move'&&obj.fen){chess.load(obj.fen);selected=null;renderBoard();}
  });
}

document.getElementById('guestApplyBtn').onclick=()=>{
  const txt=guestInput.value.trim();
  if(!txt){alert('Vlož signál hosta');return;}
  peer=new SimplePeer({initiator:false,trickle:false});
  peer.on('signal',data=>{alert('Pošli tento kód hostovi: '+JSON.stringify(data));});
  peer.on('connect',()=>{connected=true;alert('Připojeno k hostu');gamePanel.style.display='block';codePanel.style.display='none';renderBoard();});
  peer.on('data',d=>{
    const obj=JSON.parse(d.toString());
    if(obj.type==='move'&&obj.fen){chess.load(obj.fen);selected=null;renderBoard();}
  });
  peer.signal(JSON.parse(txt));
}

// ====== Initial ======
renderBoard();
</script>
</body>
</html>
